<!DOCTYPE html>
<html>
<head>
  <title>Booking Management - Admin Interface</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #4285f4, #00c5d7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-align: center;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .booking-item {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .booking-info {
      flex-grow: 1;
    }
    .booking-actions {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .btn-warning {
      background-color: #ffc107;
      color: black;
    }
    .btn-warning:hover {
      background-color: #e0a800;
    }
    .btn-primary {
      background-color: #4285f4;
      color: white;
    }
    .btn-primary:hover {
      background-color: #3367d6;
    }
    .status-confirmed {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .status-cancelled {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      opacity: 0.7;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-item {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìÖ Booking Management</h1>
    <p>Manage appointments for Eric's House of Harmony</p>
  </div>

  <div class="section">
    <h2>üìä Quick Stats</h2>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalBookings">0</div>
        <div>Total Bookings</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="confirmedBookings">0</div>
        <div>Confirmed</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cancelledBookings">0</div>
        <div>Cancelled</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayBookings">0</div>
        <div>Today's Bookings</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>üîç Filters & Actions</h2>
    <div class="filters">
      <div class="filter-item">
        <label for="statusFilter">Status:</label>
        <select id="statusFilter">
          <option value="">All Statuses</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Booked">Pending</option>
          <option value="Canceled">Cancelled</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="dateFilter">Date Range:</label>
        <select id="dateFilter">
          <option value="all">All Dates</option>
          <option value="today">Today</option>
          <option value="tomorrow">Tomorrow</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="serviceFilter">Service:</label>
        <select id="serviceFilter">
          <option value="">All Services</option>
        </select>
      </div>
      <div class="filter-item">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="refreshBookings()">üîÑ Refresh</button>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button class="btn btn-warning" onclick="showBatchCancelModal()">‚ö†Ô∏è Batch Cancel</button>
      <button class="btn btn-primary" onclick="exportBookings()">üìã Export Data</button>
    </div>
  </div>

  <div class="section">
    <h2>üìã Current Bookings</h2>
    <div id="loadingMessage" class="loading">Loading bookings...</div>
    <div id="bookingsList"></div>
  </div>

  <!-- Single Cancellation Modal -->
  <div id="cancelModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCancelModal()">&times;</span>
      <h2>Cancel Appointment</h2>
      <div id="cancelBookingDetails"></div>
      <div class="form-group">
        <label for="cancelReason">Reason for Cancellation:</label>
        <textarea id="cancelReason" rows="3" placeholder="Optional: Explain why this appointment is being cancelled..."></textarea>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-danger" onclick="confirmCancellation()">Confirm Cancellation</button>
        <button class="btn" onclick="closeCancelModal()" style="background: #6c757d; color: white;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Batch Cancellation Modal -->
  <div id="batchCancelModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBatchCancelModal()">&times;</span>
      <h2>Batch Cancel Appointments</h2>
      <p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è This will cancel ALL confirmed appointments in the selected date range!</p>
      
      <div class="form-group">
        <label for="batchStartDate">Start Date:</label>
        <input type="date" id="batchStartDate" required>
      </div>
      
      <div class="form-group">
        <label for="batchEndDate">End Date:</label>
        <input type="date" id="batchEndDate" required>
      </div>
      
      <div class="form-group">
        <label for="batchReason">Reason for Mass Cancellation:</label>
        <textarea id="batchReason" rows="3" placeholder="e.g., Emergency closure, illness, etc." required></textarea>
      </div>
      
      <div id="batchPreview" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
        <h4>Appointments to be cancelled:</h4>
        <div id="batchPreviewList"></div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-warning" onclick="previewBatchCancel()">Preview Cancellations</button>
        <button class="btn btn-danger" onclick="confirmBatchCancellation()" id="confirmBatchBtn" disabled>Confirm Batch Cancel</button>
        <button class="btn" onclick="closeBatchCancelModal()" style="background: #6c757d; color: white;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let allBookings = [];
    let filteredBookings = [];
    let currentCancelBooking = null;

    // Initialize the page
    function init() {
      console.log('Initializing admin interface...');
      setupDateDefaults();
      loadBookings();
      
      // Set up filter change listeners
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('dateFilter').addEventListener('change', applyFilters);
      document.getElementById('serviceFilter').addEventListener('change', applyFilters);
    }

    function setupDateDefaults() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('batchStartDate').value = today;
      document.getElementById('batchEndDate').value = today;
    }

    function loadBookings() {
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('bookingsList').innerHTML = '';
      
      // Call Google Apps Script function to get bookings
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(handleBookingsData)
          .withFailureHandler(handleBookingsError)
          .getAllBookingsForAdmin();
      } else {
        // Mock data for testing
        console.warn('Google Apps Script not available, using mock data');
        setTimeout(() => {
          handleBookingsData(getMockBookings());
        }, 1000);
      }
    }

    function handleBookingsData(bookings) {
      console.log('Received bookings data:', bookings);
      allBookings = bookings || [];
      
      // Populate service filter
      populateServiceFilter();
      
      // Update stats
      updateStats();
      
      // Apply current filters
      applyFilters();
      
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function handleBookingsError(error) {
      console.error('Error loading bookings:', error);
      document.getElementById('loadingMessage').innerHTML = 
        '<div style="color: #dc3545;">‚ùå Error loading bookings: ' + error.message + '</div>';
    }

    function populateServiceFilter() {
      const serviceFilter = document.getElementById('serviceFilter');
      const services = [...new Set(allBookings.map(b => b.service))];
      
      // Clear existing options except "All Services"
      serviceFilter.innerHTML = '<option value="">All Services</option>';
      
      services.forEach(service => {
        if (service) {
          const option = document.createElement('option');
          option.value = service;
          option.textContent = service;
          serviceFilter.appendChild(option);
        }
      });
    }

    function updateStats() {
      const total = allBookings.length;
      const confirmed = allBookings.filter(b => b.status === 'Confirmed').length;
      const cancelled = allBookings.filter(b => b.status.includes('Cancel')).length;
      
      const today = new Date().toISOString().split('T')[0];
      const todayBookings = allBookings.filter(b => {
        const bookingDate = new Date(b.date).toISOString().split('T')[0];
        return bookingDate === today && b.status === 'Confirmed';
      }).length;

      document.getElementById('totalBookings').textContent = total;
      document.getElementById('confirmedBookings').textContent = confirmed;
      document.getElementById('cancelledBookings').textContent = cancelled;
      document.getElementById('todayBookings').textContent = todayBookings;
    }

    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;
      const serviceFilter = document.getElementById('serviceFilter').value;

      filteredBookings = allBookings.filter(booking => {
        // Status filter
        if (statusFilter && booking.status !== statusFilter) {
          return false;
        }

        // Service filter
        if (serviceFilter && booking.service !== serviceFilter) {
          return false;
        }

        // Date filter
        if (dateFilter && dateFilter !== 'all') {
          const bookingDate = new Date(booking.date);
          const today = new Date();
          
          switch (dateFilter) {
            case 'today':
              if (bookingDate.toDateString() !== today.toDateString()) return false;
              break;
            case 'tomorrow':
              const tomorrow = new Date(today);
              tomorrow.setDate(tomorrow.getDate() + 1);
              if (bookingDate.toDateString() !== tomorrow.toDateString()) return false;
              break;
            case 'week':
              const weekFromNow = new Date(today);
              weekFromNow.setDate(weekFromNow.getDate() + 7);
              if (bookingDate < today || bookingDate > weekFromNow) return false;
              break;
            case 'month':
              const monthFromNow = new Date(today);
              monthFromNow.setMonth(monthFromNow.getMonth() + 1);
              if (bookingDate < today || bookingDate > monthFromNow) return false;
              break;
          }
        }

        return true;
      });

      renderBookings();
    }

    function renderBookings() {
      const container = document.getElementById('bookingsList');
      
      if (filteredBookings.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No bookings found matching your filters.</div>';
        return;
      }

      // Sort by date and time
      filteredBookings.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + a.time);
        const dateB = new Date(b.date + ' ' + b.time);
        return dateA - dateB;
      });

      let html = '';
      filteredBookings.forEach(booking => {
        const statusClass = booking.status.includes('Cancel') ? 'status-cancelled' : 'status-confirmed';
        const isUpcoming = new Date(booking.date + ' ' + booking.time) > new Date();
        
        html += `
          <div class="booking-item ${statusClass}">
            <div class="booking-info">
              <h4 style="margin: 0 0 10px 0; color: #333;">
                ${booking.name} - ${booking.service}
                ${booking.status.includes('Cancel') ? '<span style="color: #dc3545;">(CANCELLED)</span>' : ''}
              </h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px; color: #666;">
                <div><strong>üìß Email:</strong> <a href="mailto:${booking.email}">${booking.email}</a></div>
                <div><strong>üìû Phone:</strong> <a href="tel:${booking.phone}">${booking.phone}</a></div>
                <div><strong>üìÖ Date:</strong> ${formatDateDisplay(booking.date)}</div>
                <div><strong>üïê Time:</strong> ${formatTimeDisplay(booking.time)}</div>
                <div><strong>‚è±Ô∏è Duration:</strong> ${booking.duration} min</div>
                <div><strong>üí∞ Price:</strong> ${parseFloat(booking.price || 0).toFixed(2)}</div>
                <div><strong>üìã Status:</strong> ${booking.status}</div>
                ${booking.eventId ? `<div><strong>üÜî Event ID:</strong> <small>${booking.eventId}</small></div>` : ''}
              </div>
            </div>
            <div class="booking-actions">
              ${!booking.status.includes('Cancel') && isUpcoming ? `
                <button class="btn btn-danger" onclick="showCancelModal('${booking.eventId}', '${booking.name}', '${booking.service}', '${booking.date}', '${booking.time}')">
                  üö´ Cancel
                </button>
              ` : ''}
              ${booking.eventId ? `
                <button class="btn btn-primary" onclick="openCalendarEvent('${booking.eventId}')">
                  üìÖ View in Calendar
                </button>
              ` : ''}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function formatDateDisplay(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function formatTimeDisplay(timeStr) {
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    function showCancelModal(eventId, name, service, date, time) {
      currentCancelBooking = { eventId, name, service, date, time };
      
      document.getElementById('cancelBookingDetails').innerHTML = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
          <h4>Appointment to Cancel:</h4>
          <p><strong>Client:</strong> ${name}</p>
          <p><strong>Service:</strong> ${service}</p>
          <p><strong>Date:</strong> ${formatDateDisplay(date)}</p>
          <p><strong>Time:</strong> ${formatTimeDisplay(time)}</p>
        </div>
      `;
      
      document.getElementById('cancelModal').style.display = 'block';
    }

    function closeCancelModal() {
      document.getElementById('cancelModal').style.display = 'none';
      document.getElementById('cancelReason').value = '';
      currentCancelBooking = null;
    }

    function confirmCancellation() {
      if (!currentCancelBooking) return;
      
      const reason = document.getElementById('cancelReason').value;
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            alert('‚úÖ ' + result);
            closeCancelModal();
            refreshBookings();
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .adminCancelBooking(currentCancelBooking.eventId, reason);
      } else {
        alert('‚úÖ Booking cancelled successfully (demo mode)');
        closeCancelModal();
      }
    }

    function showBatchCancelModal() {
      document.getElementById('batchCancelModal').style.display = 'block';
    }

    function closeBatchCancelModal() {
      document.getElementById('batchCancelModal').style.display = 'none';
      document.getElementById('batchReason').value = '';
      document.getElementById('batchPreview').style.display = 'none';
      document.getElementById('confirmBatchBtn').disabled = true;
    }

    function previewBatchCancel() {
      const startDate = document.getElementById('batchStartDate').value;
      const endDate = document.getElementById('batchEndDate').value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
      }

      const start = new Date(startDate);
      const end = new Date(endDate);
      
      const bookingsToCancel = allBookings.filter(booking => {
        const bookingDate = new Date(booking.date);
        return bookingDate >= start && bookingDate <= end && booking.status === 'Confirmed';
      });

      const previewList = document.getElementById('batchPreviewList');
      if (bookingsToCancel.length === 0) {
        previewList.innerHTML = '<p style="color: #666;">No confirmed bookings found in this date range.</p>';
        document.getElementById('confirmBatchBtn').disabled = true;
      } else {
        let html = `<p><strong>${bookingsToCancel.length} appointments will be cancelled:</strong></p><ul>`;
        bookingsToCancel.forEach(booking => {
          html += `<li>${booking.name} - ${booking.service} on ${formatDateDisplay(booking.date)} at ${formatTimeDisplay(booking.time)}</li>`;
        });
        html += '</ul>';
        previewList.innerHTML = html;
        document.getElementById('confirmBatchBtn').disabled = false;
      }

      document.getElementById('batchPreview').style.display = 'block';
    }

    function confirmBatchCancellation() {
      const startDate = document.getElementById('batchStartDate').value;
      const endDate = document.getElementById('batchEndDate').value;
      const reason = document.getElementById('batchReason').value;
      
      if (!startDate || !endDate || !reason) {
        alert('Please fill in all fields');
        return;
      }

      if (!confirm('‚ö†Ô∏è Are you sure you want to cancel ALL confirmed appointments in this date range? This action cannot be undone!')) {
        return;
      }

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            alert('‚úÖ ' + result);
            closeBatchCancelModal();
            refreshBookings();
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .batchCancelBookings(startDate, endDate, reason);
      } else {
        alert('‚úÖ Batch cancellation completed (demo mode)');
        closeBatchCancelModal();
      }
    }

    function refreshBookings() {
      loadBookings();
    }

    function openCalendarEvent(eventId) {
      // Open Google Calendar event in new tab
      const calendarUrl = `https://calendar.google.com/calendar/u/0/r/eventedit/${eventId}`;
      window.open(calendarUrl, '_blank');
    }

    function exportBookings() {
      // Create CSV content
      let csv = 'Name,Email,Phone,Service,Date,Time,Duration,Price,Status,Event ID\n';
      
      filteredBookings.forEach(booking => {
        csv += `"${booking.name}","${booking.email}","${booking.phone}","${booking.service}","${booking.date}","${booking.time}","${booking.duration}","${booking.price}","${booking.status}","${booking.eventId || ''}"\n`;
      });

      // Download CSV file
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `bookings_export_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      window.URL.revokeObjectURL(url);
    }

    // Mock data for testing
    function getMockBookings() {
      return [
        {
          name: "John Doe",
          email: "john@example.com",
          phone: "555-0123",
          service: "Sound Healing Session",
          date: "2025-06-04",
          time: "14:00",
          duration: "60",
          price: "120.00",
          status: "Confirmed",
          eventId: "mock_event_1"
        },
        {
          name: "Jane Smith",
          email: "jane@example.com",
          phone: "555-0124",
          service: "Chakra Balancing",
          date: "2025-06-05",
          time: "10:00",
          duration: "90",
          price: "150.00",
          status: "Confirmed",
          eventId: "mock_event_2"
        }
      ];
    }

    // Window click event for modal closing
    window.onclick = function(event) {
      const cancelModal = document.getElementById('cancelModal');
      const batchModal = document.getElementById('batchCancelModal');
      
      if (event.target === cancelModal) {
        closeCancelModal();
      }
      if (event.target === batchModal) {
        closeBatchCancelModal();
      }
    }

    // Initialize when page loads
    window.onload = init;
  </script>
</body>
</html>